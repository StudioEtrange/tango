
[![made-with-bash](https://img.shields.io/badge/-Made%20with%20Bash-1f425f.svg?logo=image%2Fpng%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw%2FeHBhY2tldCBiZWdpbj0i77u%2FIiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8%2BIDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTExIDc5LjE1ODMyNSwgMjAxNS8wOS8xMC0wMToxMDoyMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkE3MDg2QTAyQUZCMzExRTVBMkQxRDMzMkJDMUQ4RDk3IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkE3MDg2QTAzQUZCMzExRTVBMkQxRDMzMkJDMUQ4RDk3Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QTcwODZBMDBBRkIzMTFFNUEyRDFEMzMyQkMxRDhEOTciIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QTcwODZBMDFBRkIzMTFFNUEyRDFEMzMyQkMxRDhEOTciLz4gPC9yZGY6RGVzY3JpcHRpb24%2BIDwvcmRmOlJERj4gPC94OnhtcG1ldGE%2BIDw%2FeHBhY2tldCBlbmQ9InIiPz6lm45hAAADkklEQVR42qyVa0yTVxzGn7d9Wy03MS2ii8s%2BeokYNQSVhCzOjXZOFNF4jx%2BMRmPUMEUEqVG36jo2thizLSQSMd4N8ZoQ8RKjJtooaCpK6ZoCtRXKpRempbTv5ey83bhkAUphz8fznvP8znn%2B%2F3NeEEJgNBoRRSmz0ub%2FfuxEacBg%2FDmYtiCjgo5NG2mBXq%2BH5I1ogMRk9Zbd%2BQU2e1ML6VPLOyf5tvBQ8yT1lG10imxsABm7SLs898GTpyYynEzP60hO3trHDKvMigUwdeaceacqzp7nOI4n0SSIIjl36ao4Z356OV07fSQAk6xJ3XGg%2BLCr1d1OYlVHp4eUHPnerU79ZA%2F1kuv1JQMAg%2BE4O2P23EumF3VkvHprsZKMzKwbRUXFEyTvSIEmTVbrysp%2BWr8wfQHGK6WChVa3bKUmdWou%2BjpArdGkzZ41c1zG%2Fu5uGH4swzd561F%2BuhIT4%2BLnSuPsv9%2BJKIpjNr9dXYOyk7%2FBZrcjIT4eCnoKgedJP4BEqhG77E3NKP31FO7cfQA5K0dSYuLgz2TwCWJSOBzG6crzKK%2BohNfni%2Bx6OMUMMNe%2Fgf7ocbw0v0acKg6J8Ql0q%2BT%2FAXR5PNi5dz9c71upuQqCKFAD%2BYhrZLEAmpodaHO3Qy6TI3NhBpbrshGtOWKOSMYwYGQM8nJzoFJNxP2HjyIQho4PewK6hBktoDcUwtIln4PjOWzflQ%2Be5yl0yCCYgYikTclGlxadio%2BBQCSiW1UXoVGrKYwH4RgMrjU1HAB4vR6LzWYfFUCKxfS8Ftk5qxHoCUQAUkRJaSEokkV6Y%2F%2BJUOC4hn6A39NVXVBYeNP8piH6HeA4fPbpdBQV5KOx0QaL1YppX3Jgk0TwH2Vg6S3u%2BdB91%2B%2FpuNYPYFl5uP5V7ZqvsrX7jxqMXR6ff3gCQSTzFI0a1TX3wIs8ul%2Bq4HuWAAiM39vhOuR1O1fQ2gT%2F26Z8Z5vrl2OHi9OXZn995nLV9aFfS6UC9JeJPfuK0NBohWpCHMSAAsFe74WWP%2BvT25wtP9Bpob6uGqqyDnOtaeumjRu%2ByFu36VntK%2FPA5umTJeUtPWZSU9BCgud661odVp3DZtkc7AnYR33RRC708PrVi1larW7XwZIjLnd7R6SgSqWSNjU1B3F72pz5TZbXmX5vV81Yb7Lg7XT%2FUXriu8XLVqw6c6XqWnBKiiYU%2BMt3wWF7u7i91XlSEITwSAZ%2FCzAAHsJVbwXYFFEAAAAASUVORK5CYII%3D)](https://www.gnu.org/software/bash/)

# Tango

A docker-compose file generator and manager, powered with Traefik2.

Tango is a command line tool that generate and manage a docker-compose file0
## Main features

* Generate and manage/run a fully preconfigured docker-compose file
* Entirely configurable through environment variables and file
* Create Traefik2 rules and configuration for each declared HTTP, UDP or TCP declared services
* Support Let's encrypt for HTTPS certificate generation
* Can isolate a specific service into a VPN (aka attach a vpn to only one container)



## Requirements

* bash 4
* git
* docker engine
* a wildcard domain name that point to your host (*.domain.org)


## Usage


### Install

* Install

    ```
    git clone https://github.com/StudioEtrange/tango
    cd tango
    ./tango install
    ```

### Minimal standalone sample usage

* Launch an instance with firefox

    ```
    ./tango up --module firefox --domain domain.org --freeport
    ./tango info --module firefox --domain domain.org
    ```

* A list of predefined services are available. They are called modules (see `pool/modules` folder)

* Tango generate for each services an URI with the service name as subdomain name by default. Here : `https://firefox.mydomain.org:port`

* If you do not have any domain setted, you could test the previous command by adding a mapping to `/etc/hosts` and use `--domain=localhost` to get `https://firefox.localhost:port` running
    ```
    127.0.0.1 localhost firefox.localhost
    ```

### Minimal application usage

An application is a set of services picked together with an optional configuration file


* Create a folder for app
    ```
    mkdir $HOME/myapp
    ```

* Create a `$HOME/myapp/myapp.env` environment file to set domain and select a module to launch
    ```
    echo "TANGO_DOMAIN=domain.org" > $HOME/myapp/myapp.env
    echo "TANGO_MODULES=firefox" >> $HOME/myapp/myapp.env
    ```
    NOTE : an env file is not a shell file. it follow the docker-compose env file syntax instead

* Launch
    ```
    ./tango up --app myapp --approot $HOME/myapp
    ```

* Print full informations
    ```
    ./tango info --app myapp --approot $HOME/myapp
    ```

* Stop all
    ```
    ./tango down
    ```

### Minimal samples usage of Tango


See samples in `samples` folder


## Available Commands



        install : deploy this app
        up [service [-b]] [--module module] [--plugin plugin] [--freeport]: launch all available services or one service"
        down [service] [--mods mod-name] [--all]: down all services or one service. Except shared internal service when in shared mode (--all force stop shared service)
        restart [service] [--module module] [--plugin plugin] [--freeport]: restart all services or one service. (same action than up & down)
        info [vpn_<id>] [--freeport] [-v] : give info. Will generate conf files and print configuration used when launching any service
        status [service] : see service status
        logs [service] [-f] : see service logs
        update <service> : get last version of docker image service. Will stop service if it was running
        shell <service> [--userroot] : launch a shell into a running service. Can be launched as root user instead of setted user
        services|modules|plugins list : list available modules or plugins. A module is a predefined service. A plugin is plug onto a service
        plugins exec-service <service>|exec <plugin> : exec all plugin attached to a service OR exec a plugin into all serviced attached




----
## Configuration and environment variables

* You could set every tango variables through environment files or shell environment variables and some from command line. 

* Tango use this resolution descending priority order for declared variables
    * Shell environment variables
    * Command line variables
    * User environment file variables
    * Modules environment file variables
    * Current app environment file variables
    * Default tango environment file variables


### Standard variables


|NAME|DESC|DEFAULT VALUE|SAMPLE VALUE|
|-|-|-|-|
|TANGO_DOMAIN|domain used to access tango. It is a regexp. `.*` stands for any domain or host ip.|`.*`|`mydomain.com`|
|TANGO_USER_ID|unix user which will run services and acces to files.|current user : `id -u`|`1000`|
|TANGO_GROUP_ID|unix group which will run services and acces to files.|current group : `id -g`|`1000`|
|APP_DATA_PATH|path on host for services configuration and data files.|`$(pwd)/workspace/tango/data`. Last part `data` can be defined by `APP_DATA_PATH_DEFAULT`|`/myapp/data`|

For full list see `tango.internal.env` file

### Using shell environment variables

* Set shell environment variables and export them before launch

    ```
    export TANGO_DOMAIN="mydomain.com" 
    export APP_DATA_PATH="/home/$USER/data" 
    ./tango info
    ```

### Using environment files


* An environment file syntax is liked docker-compose env file syntax. It is **NOT** a shell file. Values are not evaluated. 

    ```
    NETWORK_PORT_MAIN=80
    APP_DATA_PATH=../data
    TANGO_ARTEFACT_FOLDERS=/mnt/MEDIA/MOVIES /mnt/MEDIA/TV_SHOWS
    ```

* For you app, you can create an app environment file, named like the app name and which is read from application folder

    ```
    echo "TANGO_DOMAIN=mydomain.com" > $HOME/myapp/myapp.env
    ./tango info --app myapp --approot $HOME/myapp
    ```

* You could also create an user environment file, which can override an app environment file. By default it will be read from $HOME and named like the app name. If you use it with  By default it will be looked for from your home directory

    ```
    echo "TANGO_DOMAIN=mydomain.com" > $HOME/myapp.env
    ./tango info --app myapp --approot $HOME/myapp
    ```

    * You can also specify a path to the user environment file
        ```
        echo "TANGO_DOMAIN=mydomain.com" > /foo/bar/myotherfile.env
        ./tango info --app myapp --approot $HOME/myapp --env /foo/bar/myotherfile.env
        ```

* There is a special cumulative assignation sign `+=` which add values to previously declared variable values somewhere BEFORE in environment files
    ```
    FOO_LIST=db
    FOO_LIST+=blog

    # At this position while reading file TANGO_SERVICES_AVAILABLE value is "db blog"
    ```

* There is a special default assignation sign `?=` which assign a value only if no value was already assigned to the variable somewhere BEFORE in environment files
    ```
    FOO=foo
    FOO?=bar

    # At this position while reading file FOO value is "foo"
    ```

* env variable declared within one file can be reused with `{{var}}` as value later in the file.
    ```
    A=1
    B={{A}}

    # At this position while reading file B value is "1"
    ```

* External environnment variable can be used with `{{$var}}` as value
    ```
    H={{$HOME}}
    PWD={{$WORKING_DIR}}

    # At this position while reading file H value is "/home/john" 
    and PWD value is $WORKING_DIR value which is the current working directory from where tango was launched.
    ```


### Using command line variables

* A few variables can be setted with command line (like domain, user/group id, plugins, modules) using option syntax like `--domain`

* Priority order betwen variables and command line
    * Command line variables are overrided by shell environment variables
    * Command line variables (and shell environment variables) override environment files variables
        ```
        echo "TANGO_DOMAIN=domain.org" > $HOME/myapp.env
        TANGO_DOMAIN="domain.dev" ./tango info --app myapp --approot $HOME/myapp --domain domain.org 
        
        # Tango will use domain.dev
        ```
    * Exception for `--plugin` and `--module` are not overrided nor override, they are cumulative with both shell environment and environment files variables
        ```
        echo "TANGO_PLUGINS=plugin0" > $HOME/myapp.env
        TANGO_PLUGINS="plugin1 plugin2" ./tango info --app myapp --approot $HOME/myapp --plugin plugin3

        # Tango will use plugin0, plugin1, plugin2 and plugin3
        ```




### Variables of type "PATH"


* Variables ending with `_PATH` are path variables.

* Tango can manage a list of paths on host. Each managed path is fully evaluated into absolute path and can be created if not existing. `TANGO_PATH_LIST` list variable path name to manage, each of them can have their own subfolder list in the form of `<parent_name>_SUBPATH_LIST`
    ```
    TANGO_PATH_LIST=FOO_PATH BAR_PATH
    BAR_PATH_SUBPATH_LIST=VAR_PATH
    ```

* Each declared path variable in those kind of lists 
    * can have as value an absolute path, a relative path or be empty
    * can have a known parent path (if listed in `PARENT_PATH_SUBPATH_LIST`) or an unknow parent (if listed in `TANGO_PATH_LIST`)

* Each declared path variable with an absolute path value must exists before launching tango
* Each declared path variable with a relative path value will be auto created if missiung

* Each declared path variable are turned into absolute path at runtime following these path evaluation rules
    * if variable path is an absolute path, then this absoluted path is used as is
    * if variable path is a relative path, it will be relative to its parent path. If parent is unknown, `$TANGO_APP_WORK_ROOT` is used as default parent path
    * if variable path have an unknow parenthave an empty value,  its value will be the lower cased name of <variable_name> (`foo_path` for `FOO_PATH`)
        
        

* Path rules matrix

    |-|UNKNOWN PARENT|KNOWN PARENT|MISSING PATH BLOCKING|MISSING PATH CREATED|
    |-|-|-|-|-|
    |**`FOO_PATH` is an absolute path**|absolute host path : `$FOO_PATH`|*should not be possible, a subfolder must be a relative path to its parent*|YES|NO|
    |**`FOO_PATH` is a relative path**|relative to app workspace : `$TANGO_APP_WORK_ROOT/$VAR_PATH`|relative to parent path : `$PARENT_PATH/$FOO_PATH`|NO|YES|



* Samples

        ```
        export TANGO_PATH_LIST="FOO_PATH"
        export FOO_PATH="/foo"
        ./tango up --freeport
        # if /foo do not exist, it will throw an error and stop 

        export TANGO_PATH_LIST="FOO_PATH"
        export FOO_PATH=
        ./tango up --freeport
        # a subfolder `$(pwd)/workspace/tango/foo_path` will be created if not already exists

        export TANGO_PATH_LIST="FOO_PATH"
        export FOO_PATH=
        export FOO_PATH_SUBPATH_LIST="BAR_PATH"
        export BAR_PATH="bar"
        ./tango up --freeport
        
        # a subfolder `$(pwd)/workspace/foo_path` will be created and a subfolder `$(pwd)/workspace/foo/bar`

        export TANGO_PATH_LIST="FOO_PATH"
        export FOO_PATH=
        export FOO_PATH_SUBPATH_LIST="BAR_PATH"
        export BAR_PATH=
        ./tango up --freeport
        # a subfolder `$(pwd)/workspace/foo_path` will be created and a subfolder `$(pwd)/workspace/foo/bar_path`

        ```


* List of some default computed path variables at runtime

    |VARIABLE|DESC|DEFAULT VALUE|
    |-|-|-|
    |`TANGO_APP_ROOT`|current app full path. Without a current app, tango is viewed as an app itself|-|
    |`TANGO_APP_WORK_ROOT`|current app workspace full path.| `$TANGO_APP_ROOT/workspace/$TANGO_APP_NAME`|
    |`APP_DATA_PATH`|current app data path.| `$TANGO_APP_WORK_ROOT/data`|
    |`TANGO_DATA_PATH`|tango internal data path.| `$APP_DATA_PATH`|
    |`WORKING_DIR`|dir from where tango have been launched.| `equals $(pwd) before launching command`|




* `APP_DATA_PATH` is a special path variable with a purpose to store and share data of services app in one unique location. It s added to TANGO_PATH_LIST if not already done. Its default definition is
    ```
    TANGO_PATH_LIST=APP_DATA_PATH
    APP_DATA_PATH=
    APP_DATA_PATH_DEFAULT=data
    ```

* `TANGO_DATA_PATH` is a special path variable wich store generic tango data like letsencrypt data or traefik conf. Its value depends of tango instance mode (`isolated` or `shared`)
    * if `isolated` (the default mode) `TANGO_DATA_PATH` equals `APP_DATA_PATH` - they are stored as subfolder of `APP_DATA_PATH`
    * if `shared` `TANGO_DATA_PATH` is a subfolder of tango `workspace` itself




* `TANGO_ARTEFACT_FOLDERS` is a special list of folder path named `artefacts`. Those listed folders are all absolute. Listed artefacts are attached to each service listed in `TANGO_ARTEFACT_SERVICES`. The mount point into service is defined by `TANGO_ARTEFACT_MOUNT_POINT` (`/artefact` by default) concatened to the deepest tree folder name.
Artefact folder is an easy way to quick unite several folders into the same root inside a container
    * `TANGO_ARTEFACT_FOLDERS=/mnt/media/movies /foo/bar/tv /flu/bar/music` will be mounted under `/artefact/movies`, `/artefact/tv` and `/artefact/music` into each service



### For Your Information about env files and tango internal mechanisms


* At each launch tango use `tango.env` and `myapp.env` files to generate
    * `generated.myapp.compose.env` file used by docker-compose
    * `generated.myapp.bash.env` file used by shell scripts


* You may know that a `compose.env` file is read by docker-compose to replace any variable present in docker-compose file anywhere in the file but NOT for define shell environment variable inside running container ! 


    ```
    test:
        image: bash:4.4.23
        command: >
            bash -c "echo from docker compose : $NETWORK_PORT_MAIN from running container env variable : $$NETWORK_PORT_MAIN"
    ```

    * This above only show NETWORK_PORT_MAIN value but $$NETWORK_PORT_MAIN (with double dollar to not have docker-compose replace the value) is empty unless you add this :

    ```
    test:
        image: bash:4.4.23
        env_file:
            - generated.myapp.compose.env
        command: >
            bash -c "echo from docker compose : $NETWORK_PORT_MAIN from running container env variable : $$NETWORK_PORT_MAIN"
    ```

----
## Services

* A service is a feature provided by a container
* Tango expose services with traefik

* A service can be defined with a module (see below) or in an app own defined docker-compose file

### Enable/disable

* To enable a service defined in an app own compose file add it to the list `TANGO_SERVICES_AVAILABLE`. All services in this list will be enabled unless listed in variable `TANGO_SERVICES_DISABLED`

    ```
    TANGO_SERVICES_AVAILABLE=website database
    TANGO_SERVICES_DISABLED=database
    ```

### Service management

* Launch a specific service

    ```
    ./tango up <service>
    ```

* Stop a service

    ```
    ./tango down <service>
    ```

* Get abstract info on a service
    ```
    ./tango info <service>
    ```
### Creating volumes


* Add definition of named volumes, use `TANGO_VOLUMES` variable with format `<volume name><:path|#variable path name>`
    ```
    TANGO_VOLUMES="my_volume:/workspace"

    MY_PATH=/workspace
    TANGO_VOLUMES="my_volume#MY_PATH"
    ```


### Tweaking a service

* Attach volumes to a service, use `<SERVICE>_ADDITIONAL_VOLUMES` variable with format `<named volume|path><:path|#variable path name>`
    ```
    FOO_ADDITIONAL_VOLUMES="$HOME:/workspace"

    MY_PATH=/workspace
    FOO_ADDITIONAL_VOLUMES="$HOME#MY_PATH"
    ```

* Adding specific env var inside a specific service, use `<SERVICE>_SPECIFIC_ENVVAR` variable
    ```
    FOO_SPECIFIC_ENVVAR="A=1 B=2"
    ```

* Attach existing traefik middlewares to a service, use `<SERVICE>_ADDITIONAL_MIDDLEWARES=<middleware_name>[:<position>:[<position number>]]`
    ```
    FOO_ADDITIONAL_MIDDLEWARES="middleware1 middleware2:FIRST middleware3:LAST middleware4:POS:4
    ```



### Subservices

* a subservice share with its parent service a same traefik entrypoint by default (but can be override)
* to declare a subservice use `TANGO_SUBSERVICES_ROUTER` in priority ascending order relative to each other. Each subservices priority is higher than the previous one which belong to the same parent service
* subservice name format is be : `<service>_<subservice>`


----
## Modules 

* A module is a predefined ready-to-use service.

* List known modules :
     ```
    ./tango modules list
    ```


* To activate a module into the current app 
    * use variable list `TANGO_SERVICES_MODULES` or `--module` command line option
    * `--module` command line option is cumulative with variable list `TANGO_SERVICES_MODULES`
    * Item format of the list is `<module>[@<network area>][%<service dependency1>][%<service dependency2>][~<vpn id>][^<nb instances>]`
    * by default, will use default tango network area which is main - to choose another area when activating it, either use `--module <module>[@<network area>]` or `TANGO_SERVICES_MODULES=<module>[@<network area>]`. Also, you can set a default network area by adding module to NETWORK_SERVICES_AREA_entrypoint_protocol list (NETWORK_SERVICES_AREA_MAIN_HTTP+=module) in dedicated module.env file.

    ```
    CLOUD9_USERNAME=tango CLOUD9_PASSWORD=tango ./tango --module cloud9 --module firefox@secondary --domain mydomain.org --freeport up
    ```

* Some module can be scaled to N instance. An empty file `<module>.scalable` allow a module to be scaled
    ```
    ./tango --module cloud9~N
    ```

* Modules can have other services dependencies and module launch will depends on these dependencies

* Modules are located in `pool/modules` folders. You can define your own modules in your app by putting their matching `.yml` and `.env` files in a `pool/modules` folder of the app


----
## Plugins 

* A plugin is a script that will be exececuted *into a running service*
    * List plugins :
    ```
    ./tango plugins list
    ```
* A module stay in background as a service but a plugin just execute a script and stop 

* Each plugin may have some restrictions and will work only into some specific services

* A plugin can be executed at each service launch or manually with plugins commands
    ```
    tango plugins exec-service <service>
    tango plugins exec <plugin>
    ```

    * Manually execute all plugins attached to a service
        ```
        ./tango plugins exec-service <service>
        ```

    * Manually execute a plugin into all services attached
        ```
        ./tango plugins exec <plugin>
        ```
    * If the attached service is not running, the plugin cannot be executed

* A plugin must be declared before using it
* To declare a plugin into the current app 
    * use variable list `TANGO_PLUGINS` or `--plugin` command line option
    * `--plugin` command line option is cumulative with variable list `TANGO_PLUGINS`
    * Item format of the list is `<plugin>[%<auto exec at launch into service1>][%!<manual exec into service2>][#arg1][#arg2]`

* Plugins may have data stored in `$APP_DATA_PATH/plugins`

### Plugins usage sample

* Sample that attach `uname` plugin to the start of `firefox` and launch `firefox` service module
    ```
    ./tango --plugin uname%firefox --module firefox --domain mydomain.org --freeport up firefox
    ```

* Sample that attach `uname` plugin to `firefox`, launch `firefox` service then exec all plugins attached to `firefox`
    ```
    ./tango --plugin uname%!firefox --module firefox --domain mydomain.org --freeport up firefox
    ./tango plugins exec-service firefox
    ```


* Plugin will be executed inside each attached services
* Predefined plugins are in `pool/plugins` folder
* You can define your own plugins in your app by putting executable files in a `pool/plugins` folder of the app

----
## Network

### Logical area & entrypoints

* To define network logical area use this syntax

```
NETWORK_SERVICES_AREA_LIST=<name>|<protocol>|<traefik internal port>|<traefik internal secured port>
i.e : NETWORK_SERVICES_AREA_LIST=main|http|80|443 admin|http|9000|9443
```

* For each logical area one traefik entrypoint will be created. Two entrypoints if a secured port is declared

* `zone|http|80|443` will create two entrypoints with this form : `entry_zone_http` and `entry_zone_http_secure`, making traefik listening on this port. Remember that traefik is itself in a container, so this port will be mapped to an external port that will be used as port for the entrypoint.

* To declare an external port matching the entrypoint use `NETWORK_PORT_<name>[_SECURE]` form
```
NETWORK_PORT_ADMIN=30000 ==> will match internal container port 9000
NETWORK_PORT_ADMIN_SECURE=30043 ==> will match internal container port 9443
```

* There is always a main network area defined. If not declare main network is created with these characteristics : main|http|80|443

* A service can be attached to several logical area, soo you can separate each service on different area according to your needs by opening/closing your router settings. Use the form `NETWORK_SERVICES_AREA_<name>=<service>` form 

```
NETWORK_SERVICES_AREA_MAIN=web who
```

* This will attached `web` and `who` services to main logical area (which can have two entrypoints, one not secure and one secure)

### Ports and Random free port

* With `--freeport` option the port associated with each entrypoints will be randomly choosen among free TCP ports. This option override any other entrypoint ports defined with variables from shell or env files.

* Any variables values ending with `_PORT` will be excluded from the free TCP ports. (including direct access port, see below)

    ```
    ./tango --freeport --module firefox --domain=mydomain.org up
    ```
    

* `--freeport` will allocate free ports of entrypoint each times a service is started with `up` or `restart` command. These ports are saved in an internal file. When using `info` command `--freeport` will read ports from previously backup ones.

    ```
    ./tango --freeport --module firefox --domain=mydomain.org info
    ```
    

#### Direct access port

* For various purpose like debugging, you can declare a direct access HTTP port to the service to bypass traefik ang get directly to the service with variables `*_DIRECT_ACCESS_PORT`. The first port declared as `expose` in docker-compose file is mapped to its value.

    * access directly throuh http://host:7777
    ```
    MYSERVICE_DIRECT_ACCESS_PORT=7777
    ```

----
## HTTP/HTTPS configuration

### HTTPS redirection

* To enable/disable HTTP to HTTPS redirection engine, set `NETWORK_REDIRECT_HTTPS` variable
* To enable/disable HTTPS only access to each service, declare them in `NETWORK_SERVICES_REDIRECT_HTTPS` variable. An autosigned certificate will be autogenerate

* ie in user env file : 
    ```
    NETWORK_SERVICES_REDIRECT_HTTPS=traefik organizr2
    ```
### Certificate with Let's encrypt

* Variable LETS_ENCRYPT control if let's encrypt (https://letsencrypt.org/) is enabled or disabled for certificate generation
    * `LETS_ENCRYPT=disable` (default value) will disable auto generation
    * `LETS_ENCRYPT=enable` will auto generate a certificate for each services declared in `LETS_ENCRYPT_SERVICES`. (All services by default)
    * `LETS_ENCRYPT=debug` will use the test server of letsencrypt to not reach rate limit (https://letsencrypt.org/fr/docs/rate-limits/)

* NOTE : when you need to fully reset generated certificate, you have to delete the `acme.json` file Use `./tango letsencrypt rm` command for that.

* NOTE : letsencrypt do not allow "underscore" usage in name (https://community.letsencrypt.org/t/underscore-in-subdomain-fails/31431)

### Let's encrypt and non default port for main area

* If you change the network ports of main area to other ports than 80/443, you have to use change the letsencrypt method from `HTTP Challenge` to `DNS Challenge`
    * By default tango uses the `HTTP Challenge` which *requires* port 80/443 to be opened and accessible from internet (https://docs.traefik.io/user-guides/docker-compose/acme-http/). 
    * Otherwise you need to use the `DNS Challenge` and configure how to access to your DNS provider through its API (https://docs.traefik.io/user-guides/docker-compose/acme-dns/)

* How-to : in your user conf file
    * Set `LETS_ENCRYPT_CHALLENGE` to `DNS`
    * Set `LETS_ENCRYPT_CHALLENGE_DNS_PROVIDER` with your provider name 
    * Add needed variables for your providers. Consult https://docs.traefik.io/https/acme/#providers for details

    * sample :
        ```
        LETS_ENCRYPT_CHALLENGE=DNS
        LETS_ENCRYPT_CHALLENGE_DNS_PROVIDER=ovh
        OVH_ENDPOINT=xxx
        OVH_APPLICATION_KEY=xxx
        OVH_APPLICATION_SECRET=xxx
        OVH_CONSUMER_KEY=xxx
        ```




### Conception design note on router order and HTTPS Redirection (tango internal mechanisms)

* To make the system of HTTPS redirection fully customisable, we use the priority rules of traefik. Each service that need to have an HTTPS redirection use it

* We cannot use the method of set redirect middleware on each routers service because each service routers may have two entrypoints and redirect middlewares dont know from which entrypoint the request come. So we use a global catch all router rule, using priority for exclude some services

*Router order algorithm*

* if global HTTPS redirection engine disabled
    * 1.will match any HTTP service router with priority ROUTER_PRIORITY_DEFAULT_VALUE (i.e:2000)
	* 2.match error router which have a priority of ROUTER_PRIORITY_ERROR_VALUE (i.e:1800)

* if global HTTPS redirection engine enabled
    * 1.match router with HTTPS router with redirection middleware with priority ROUTER_PRIORITY_HTTP_TO_HTTPS_VALUE (i.e:1000)
    * 2.match any other router including HTTP service router with their lowered priority (i.e:500)
        * amount of priority to subtract : ROUTER_PRIORITY_DEFAULT_VALUE - ROUTER_PRIORITY_HTTP_TO_HTTPS_VALUE + (ROUTER_PRIORITY_HTTP_TO_HTTPS_VALUE / 2) (i.e:1500)
	* 3.match error router which have a lowered priority too (i.e:300)

Subservices have a priority higher than their service parent. 
In TANGO_SUBSERVICES_ROUTER each subservices, listed by group of parent service, get an increasing bonus of ROUTER_PRIORITY_DEFAULT_STEP (i.e:5) priority.

i.e with HTTPS redirection engine disabled
* TANGO_SERVICES_AVAILABLE=service1 service2
* TANGO_SUBSERVICES_ROUTER=service1_subservice1 service1_subservice2 service2_subservice1
* priorities computed : service1 : 2000, servce1_subservice1 : 2005, servce1_subservice2 : 2010,  service2 : 2000, servce2_subservice1 : 2005

----
## VPN

* Declare a vpn connection with `1` as id
    ```
    VPN_1_PATH=../mambo-data/vpn/pia_ovpn_default_recommended_conf_20200509
    VPN_1_VPN_FILES=Switzerland.ovpn
    VPN_1_VPN_AUTH=user;password
    VPN_1_DNS=1
    ```
    * These settings match ones from https://github.com/StudioEtrange/openvpn-client


### Connect a service to a VPN
* You can isolate some of your services to use this vpn connection :
    ```
    VPN_1_SERVICES=<service>
    ```

* How-To check service isolation, by checking its external ip
    ```
    ./mambo shell <service>
    curl 'https://api.ipify.org?format=json'
    ```

* services connected to a vpn 
    * have env var `VPN_ID` setted with the id of the vpn
    * inherits all env var `VPN_*`
    * have all config files inside a mounted volume at `/vpn`
    * all port declaration mapping and exposed port in compose-file are removed
    * its network alias coming from service name ais replaced by network alias from `vpn_<id>` container. Meaning cannot `ping <service>` from within other service, but `ping vpn_<id>` instead
    * the service container network become : `network_mode: service:vpn_<id>` meaning its network stack is the one from `vpn_<id>` container


## GPU

* First, you will need nvidia-docker2 or nvidia-container-toolkit depending on your docker version

* To make a GPU available into some service declare it with `SERVICE_GPU=INTEL_QUICKSYNC|NVIDIA` (ie : `PLEX_GPU=NVIDIA`)

* About intel quicksync :
    * To confirm your host kernel supports the Intel Quick Sync feature, the following command can be executed on the host `lspci -v -s $(lspci | grep VGA | cut -d" " -f 1)` which should output `Kernel driver in use: i915` 
    * If your Docker host also has a dedicated graphics card, the video encoding acceleration of Intel Quick Sync Video may become unavailable when the GPU is in use. 


## Optional DNS Configuration

* As requirements you have a wildcard domain name that point to your host (*.domain.org). But you can optimize this by configuring the wildcard domain to be solved 
    * as your external public IP when requested from outside
    * and as your local machine IP hosting tango when requested from local network

* You can do this in your internet box or any software that manage your local network DNS server
    * sample for OpenWrt configuration using dnsmasq to resolve any *.domain.org or domain.org as a unique 192.168.0.50 host inside localhost
        ```
        uci add_list dhcp.@dnsmasq[0].address="/domain.org/192.168.0.50"
        uci changes firewall
        uci commit
        /etc/init.d/firewall reload
        ```
    * sample for pfsense to resolve any *.domain.org or domain.org as a unique 192.168.0.50 host inside localhost
        * Go to Services / DNS Forwarder
        * Pick Custom options and set `address=/domain.org/192.168.0.50`
        
## Troubleshooting


* Problem with a volume
    * May occurs when you move some folder with your data
    * FIX : delete docker volume with `docker volume rm <volumename>`
    * Sample
    ```
       ERROR: Configuration for volume tango_shared_internal_data specifies "device" driver_opt /foo/folder/tango_shared, but a volume with the same name uses a different "device" driver_opt (/foo/bar/tango_shared). If you wish to use the new configuration, please remove the existing volume "tango_shared_internal_data" first:
        $ docker volume rm tango_shared_internal_data
    ```


## Side notes

* I cannot use 3.x docker compose version, while `--runtime` or `--gpus` are not supported in docker compose format (https://github.com/docker/compose/issues/6691)

* Why Bash ? Because ^^